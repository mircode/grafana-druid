{"version":3,"sources":["../src/query_model.js"],"names":["_","QueryPart","QueryCtrl","kbn","QueryModel","target","templateSrv","uiSegmentSrv","scopedVars","chartFormats","dsType","editor","table","value","fake","select","type","params","where","groupBy","orderBy","limit","interpolate","replace","newSegment","segment","map","parts","create","selectParts","part","def","getSelect","selectText","render","join","partModel","order","getOrderBy","orderPart","tag","newPlusButton","custom","group","field","filter","newCondition","newKey","newKeyValue","newOperator","cssClass","self","index","opt","toLowerCase","val","reg","format","formatWhere","test","variable","defaultFormatFn","includeAll","current","text","all","pre","suf","isArray","vals","regexEscape","rawQuery","query","sql","renderSelect","renderTable","renderWhere","renderGroupBy","renderOrderBy","renderLimit","length"],"mappings":"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","file":"query_model.js","sourcesContent":["import _ from 'lodash';\n\nimport QueryPart   from './query_part';\nimport {QueryCtrl} from 'app/plugins/sdk';\nimport kbn from 'app/core/utils/kbn';\n\n// query model\nexport default class QueryModel {\n\n\t// constructor\n\tconstructor(target, templateSrv, uiSegmentSrv, scopedVars) {\n\t\t// basic\n\t\tthis.target = target;\n\t\tthis.scopedVars = scopedVars;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.uiSegmentSrv = uiSegmentSrv;\n\n\t\t// chart type\n\t\ttarget.chartFormats = target.chartFormats || 'table';\n\t\t// database type\n\t\ttarget.dsType = 'sql';\n\t\t// editor\n\t\ttarget.editor=false;\n\t\t\n\t\t// table\n\t\ttarget.table = target.table || {value: 'select (table)',fake: true};\n\t\t// select\n\t\ttarget.select = target.select || [[{type: 'field',params: ['value']}]];\n\t\t// where\n\t\ttarget.where = target.where || [{type: 'plus-button'}];\n\t\t// group by\n\t\ttarget.groupBy = target.groupBy || [{type: 'plus-button'}];\n\t\t// order by\n\t\ttarget.orderBy = target.orderBy || [];\n\t\t// limit\n\t\ttarget.limit = target.limit;\n\n\t}\n\n\t// table\n\tgetTable(interpolate) {\n\t\tvar table = this.target.table;\n\t\tif(interpolate) {\n\t\t\ttable = this.templateSrv.replace(table, this.scopedVars, 'regex');\n\t\t}\n\t\treturn this.uiSegmentSrv.newSegment(table);\n\t}\n\tupdateTable(segment) {\n\t\tthis.target.table = segment.value;\n\t}\n\trenderTable(interpolate){\n\t\treturn this.target.table;\n\t}\n\t\n\t// select\n\tgetSelect() {\n\t\treturn _.map(this.target.select, function(parts) {\n\t\t\treturn _.map(parts, QueryPart.create);\n\t\t});\n\t}\n\tupdateSelect(select) {\n\t\tthis.target.select = _.map(select, function(selectParts) {\n\t\t\treturn _.map(selectParts, function(part) {\n\t\t\t\treturn {\n\t\t\t\t\ttype: part.def.type,\n\t\t\t\t\tparams: part.params\n\t\t\t\t};\n\t\t\t});\n\t\t});\n\t}\n\trenderSelect(){\n\t\t\n\t\t// 遍历select\n\t\tvar select=_.map(this.getSelect(), function(selectParts) {\n\t\t\tvar selectText='';\n\t\t\t_.map(selectParts, function(part) {\n\t\t\t\tselectText=part.render(selectText);\n\t\t\t});\n\t\t\treturn selectText;\n\t\t});\n\t\treturn select.join(',');\n\t}\n\n\t// order\n\tgetOrderBy() {\n\t\treturn _.map(this.target.orderBy, QueryPart.create);\n\t}\n\tupdateOrderBy(orderBy) {\n\t\tthis.target.orderBy = _.map(orderBy, function(partModel) {\n\t\t\treturn partModel.part;\n\t\t});\n\t}\n\trenderOrderBy(){\n\t\tvar order=_.map(this.getOrderBy(), function(orderPart) {\n\t\t\treturn orderPart.render('');\n\t\t});\n\t\treturn order.join(',');\n\t}\n\t// group\n\tgetGroupBy() {\n\t\tvar uiSegmentSrv = this.uiSegmentSrv;\n\t\treturn _.map(this.target.groupBy, function(tag) {\n\t\t\tif(tag.type === 'plus-button') {\n\t\t\t\treturn uiSegmentSrv.newPlusButton();\n\t\t\t}\n\t\t\tif(tag.type === 'group') {\n\t\t\t\treturn uiSegmentSrv.newSegment({\n\t\t\t\t\tvalue: tag.value,\n\t\t\t\t\ttype: 'group',\n\t\t\t\t\tcustom: tag.value\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\tupdateGroupBy(groupBy) {\n\t\tthis.target.groupBy = _.map(groupBy, function(segment) {\n\t\t\treturn {\n\t\t\t\tvalue: segment.value,\n\t\t\t\ttype: segment.type\n\t\t\t};\n\t\t})\n\t}\n\trenderGroupBy(){\n\t\tvar group=_.map(this.target.groupBy,function(field){\n\t\t\tif(field.value){\n\t\t\t\treturn field.value;\n\t\t\t}\n\t\t});\n\t\t// 过滤空值\n\t\tgroup=_.filter(group,function(field){ return field||field==='';})\n\t\treturn group.join(',');\n\t}\n\t\n\t// where\n\tgetWhere() {\n\t\tvar uiSegmentSrv = this.uiSegmentSrv;\n\t\treturn _.map(this.target.where, function(tag) {\n\t\t\t//  and|or\n\t\t\tif(tag.type === 'condition') {\n\t\t\t\treturn uiSegmentSrv.newCondition(tag.value);\n\t\t\t}\n\t\t\tif(tag.type === 'key') {\n\t\t\t\tvar segment=uiSegmentSrv.newKey(tag.value);\n\t\t\t\t// field type\n\t\t\t\tsegment.custom=tag.custom;\n\t\t\t\treturn segment;\n\t\t\t}\n\t\t\tif(tag.type === 'plus-button') {\n\t\t\t\treturn uiSegmentSrv.newPlusButton();\n\t\t\t}\n\t\t\tif(tag.type === 'value') {\n\t\t\t\treturn uiSegmentSrv.newKeyValue(tag.value);\n\t\t\t}\n\t\t\tif(tag.type === 'operator') {\n\t\t\t\treturn uiSegmentSrv.newOperator(tag.value);\n\t\t\t}\n\t\t\tif(tag.type === 'bracket') {\n\t\t\t\treturn uiSegmentSrv.newSegment({\n\t\t\t\t\tvalue: tag.value,\n\t\t\t\t\ttype: 'bracket',\n\t\t\t\t\tcssClass: 'query-segment-operator'\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\tupdateWhere(where) {\n\t\tthis.target.where = _.map(where, function(segment) {\n\t\t\treturn {\n\t\t\t\tvalue: segment.value,\n\t\t\t\ttype: segment.type,\n\t\t\t\tcustom: segment.custom\n\t\t\t};\n\t\t});\n\t}\n\trenderWhere(interpolate){\n\t\tvar self=this;\n\t\tvar where= _.map(self.target.where, (tag, index) => {\n\t\t\t\n\t\t\t// 不需要render\n\t\t\tif(!interpolate) {\n\t\t\t\treturn tag.value;\n\t\t\t}\n\t\t\t\n\t\t\t// 如果是key或者value,返回空串\n\t\t\tif(tag.type === 'key' || tag.type === 'value'){\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\tif(tag.type === 'operator'){\n\t\t\t\tvar field=self.target.where[index-1];\n\t\t\t\tvar opt=self.target.where[index];\n\t\t\t\tvar value=self.target.where[index+1];\n\t\t\t\tvar type=field.custom.toLowerCase();\n\t\t\t\t\n\t\t\t\tvar val=value.value;\n\t\t\t\tvar reg=/\\$(\\w+)|\\[\\[([\\s\\S]+?)\\]\\]/g;\n\t\t\t\t\n\t\t\t\t// 更具字段值,字段类型,操作类型 柯里化函数 \n\t\t\t\tvar format=this.formatWhere(field.value,type,opt.value);\n\t\t\t\t// 变量替换\n\t\t\t\tif(reg.test(val)){\n\t\t\t\t\tval=this.templateSrv.replace(val,this.scopedVars,format);\n\t\t\t\t}else{\n\t\t\t\t\tval=format(val);\n\t\t\t\t}\n\t\t\t\treturn val;\n\t\t\t}\n\t\t\treturn tag.value;\n\t\t});\n\t\treturn where.join(' ');\n\t}\n\tformatWhere(field,type,opt) {\n\t\treturn function(value, variable, defaultFormatFn){\n\t\t\t\t\n\t\t\t\tif(variable&&variable.includeAll&&variable.current.text=='All'){\n\t\t\t\t\tvar all=variable.current.value;\n\t\t\t\t\treturn all==='$__all'?'1=1':all;\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t     // 正则操作\n\t\t\t\tif(/=~|!~/.test(opt)){\n\t\t\t\t\tvar pre='/^';\n\t\t\t\t\tvar suf='$/';\n\t\t\t\t    // 多值\n\t\t\t\t    if(_.isArray(value)){\n\t\t\t          \tvar vals = _.map(value, kbn.regexEscape);\n\t\t\t          \tvalue=pre+'(' + vals.join('|') + ')'+suf;\n\t\t\t          \t\n\t\t\t          \treturn field+' '+opt+' '+value;\n\t\t\t         // 单值\n\t\t          \t}else{\n\t\t          \t\tvalue=pre+value+suf;\n\t\t\t\t        return field+' '+opt+' '+value;\n\t\t          \t}\n\t\t\t\t}\n\t\t\t\t// 模糊匹配\n\t\t\t\telse if(/like|not like/.test(opt)){\n\t\t\t\t\tvar pre=\"'%\";\n\t\t\t\t\tvar suf=\"%'\";\n\t\t\t\t\t\n\t\t\t\t    // 多值\n\t\t\t\t    if(_.isArray(value)){\n\t\t\t          \tvar value = _.map(value, function(val){\n\t\t\t          \t\treturn field+' '+opt+' '+pre+val+suf;\n\t\t\t          \t}).join(opt==='like'?' or ':' and ');\n\t\t\t          \t\n\t\t\t          \treturn '('+value+')';\n\t\t\t         // 单值\n\t\t          \t}else{\n\t\t          \t\tvalue=pre+value+suf;\n\t\t\t\t        return field+' '+opt+' '+value;\n\t\t          \t}\n\t\t          \t\n\t\t\t\t}\n\t\t\t\t// 集合操作\n\t\t\t\telse if(/in|not in/.test(opt)){\n\t\t\t\t\tvar pre='(';\n\t\t\t\t\tvar suf=')';\n\t\t\t\t    if(_.isArray(value)){\n\t\t\t\t\t\tvar vals = _.map(value, function(val){\n\t\t\t          \t\tif(type.toLowerCase()==='string'){\n\t\t\t\t\t\t\t\treturn \"'\"+val+\"'\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn val;\n\t\t\t          \t});\n\t\t\t\t\t\tvalue=pre+vals.join(',')+suf;\n\t\t\t\t\t\treturn field+' '+opt+' '+value;\n\t\t\t\t\t}else{\n\t\t\t\t      \tif(type.toLowerCase()==='string'){\n\t\t\t\t\t\t\tvalue=\"'\"+value+\"'\"\n\t\t\t\t\t\t}\n\t\t\t\t      \tvalue=pre+value+suf;\n\t\t\t\t      \treturn field+' '+opt+' '+value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t // 多值\n\t\t\t\t    if(_.isArray(value)){\n\t\t\t          \tvar vals = _.map(value, function(val){\n\t\t\t          \t\tif(type.toLowerCase()==='string'){\n\t\t\t\t\t\t\t\tval=\"'\"+val+\"'\"\n\t\t\t\t\t\t\t}\n\t\t\t          \t\treturn field+' '+opt+' '+val;\n\t\t\t          \t});\n\t\t\t          \tvalue=vals.join(opt==='='?' or ':' and ');\n\t\t\t          \treturn '('+value+')';\n\t\t\t\t    }else{\n\t\t\t\t      \tif(type.toLowerCase()==='string'){\n\t\t\t\t\t\t\tvalue=\"'\"+value+\"'\"\n\t\t\t\t\t\t}\n\t\t\t\t      \treturn field+' '+opt+' '+value;\n\t\t\t\t    }\n\t\t\t\t}\n\t\t}\n    }\n\t// limit\n\trenderLimit(){\n\t\treturn this.target.limit||'';\n\t}\n\n\t\n\t// sql\n\trender(interpolate) {\n\t\tvar target = this.target;\n\t\tif(target.rawQuery) {\n\t\t\tif(interpolate) {\n\t\t\t\treturn this.templateSrv.replace(target.query, this.scopedVars, 'regex');\n\t\t\t} else {\n\t\t\t\treturn target.query;\n\t\t\t}\n\t\t}\n\t\t// sql\n\t\tvar sql='';\n\t\t\n\t\tvar select=this.renderSelect();\n\t\tvar table=this.renderTable();\n\t\tvar where=this.renderWhere(interpolate);\n\t\tvar groupBy=this.renderGroupBy();\n\t\tvar orderBy=this.renderOrderBy();\n\t\tvar limit=this.renderLimit();\n\t\t\n\t\tif(select.length>0)  sql +='SELECT '+select;\n\t\tif(table.length>0)   sql +=' FROM '+table;\n\t\tif(where.length>0)   sql +=' WHERE '+where;\n\t\tif(groupBy.length>0) sql +=' GROUP BY '+groupBy;\n\t\tif(orderBy.length>0) sql +=' ORDER BY '+orderBy;\n\t\tif(limit.length>0)   sql +=' LIMIT '+limit;\n\t\t\n\t\tif(interpolate) {\n        \tsql = this.templateSrv.replace(sql,this.scopedVars,'regex');\n      \t}\n\t\ttarget.query=sql;\n\t\treturn sql;\n\t}\n}"]}