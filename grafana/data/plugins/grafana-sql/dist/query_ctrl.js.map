{"version":3,"sources":["../src/query_ctrl.js"],"names":["angular","_","QueryPart","QueryModel","QueryBuilder","QueryCtrl","SQLEditor","SQLQueryCtrl","$scope","$injector","templateSrv","$q","uiSegmentSrv","alertSrv","target","model","panel","scopedVars","queryBuilder","datasource","initChart","initTable","initWhere","initSelect","initGroup","initOrder","initEditor","chartFormats","text","value","table","getTable","queryTables","then","transformToSegments","catch","handleQueryError","bind","updateTable","panelCtrl","refresh","select","getSelect","selectMenu","getSelectMenu","selectParts","part","evt","name","queryColumns","removeSelectPart","when","cat","subitem","create","type","def","addStrategy","updateSelect","length","modelsIndex","indexOf","splice","partIndex","orderBy","getOrderBy","orderMenu","getOrderMenu","index","removeOrderPart","partModel","params","push","updateOrderBy","groupBy","getGroupBy","tmp","segment","removeSegment","createSegment","fake","that","results","copy","filter","seg","custom","newPlusButton","updateGroupBy","bracketSegment","cssClass","where","getWhere","newOperators","field","aliasName","getAliasName","queryColumnValue","map","result","deep","i","pre","Math","max","and","newCondition","left","plus","right","plus_out","_key","opt","newOperator","newFake","segment_pre","col","updateWhere","query","render","sql","rawQuery","editor","format","set","addTemplateVars","addAliasName","segments","expandable","variables","variable","unshift","self","as","err","error","message","options","newSegment","selectmenu","getCategory","undefined","category","Fields","AS","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["\nimport angular from 'angular';\nimport _ from 'lodash';\n\nimport QueryPart    from './query_part';\nimport QueryModel   from './query_model';\nimport QueryBuilder from './query_builder';\nimport {QueryCtrl}  from 'app/plugins/sdk';\n\nimport SQLEditor from './lib/sql_editor.js';\t\n\n\n\n// 查询Controller\nexport class SQLQueryCtrl extends QueryCtrl {\n\n\t// 构造函数\n\tconstructor($scope, $injector, templateSrv, $q, uiSegmentSrv,alertSrv) {\n\t\tsuper($scope, $injector);\n\n\t\t// 保存基本信息\n\t\tthis.$q = $q;\n\t\tthis.target = this.target;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.uiSegmentSrv = uiSegmentSrv;\n\t\tthis.alertSrv=alertSrv;\n\t\t\n\t\t// 查询Model\n\t\tthis.model = new QueryModel(this.target, templateSrv,uiSegmentSrv, this.panel.scopedVars);\n\t\t// 查询对象\n\t\tthis.queryBuilder = new QueryBuilder(this.target, this.datasource);\n\n\t\t// 初始化Chart\n\t\tthis.initChart();\n\t\t// 初始化Table\n\t\tthis.initTable();\n\t\t// 初始化Where\n\t\tthis.initWhere();\n\t\t// 初始化Select\n\t\tthis.initSelect();\n\t\t// 初始化Group\n\t\tthis.initGroup();\n\t\t// 初始化Order\n\t\tthis.initOrder();\n\t\t\n\t\t// 初始SQL编辑器\n\t\tthis.initEditor();\n\t}\n\n\t//=================\n\t// chart相关函数\n\t//=================\n\tinitChart() {\n\t\t// 图标类型\n\t\tthis.chartFormats = [\n\t\t\t{text: '时序图',value: 'time_series'}, \n\t\t\t{text: '表格',value: 'table'},\n\t\t];\n\t}\n\t\n\t//=================\n\t// table相关函数\n\t//=================\n\tinitTable(){\n\t\tthis.table=this.model.getTable();\n\t}\n\tgetTables(){\n\t\treturn this.queryBuilder.queryTables()\n\t\t\t\t\t\t\t  \t.then(this.transformToSegments(true))\n\t\t\t\t\t\t\t  \t.catch(this.handleQueryError.bind(this));\n\t}\n\ttableChanged(){\n\t\tthis.model.updateTable(this.table);\n\t\tthis.panelCtrl.refresh();\n\t}\n\n\t//=================\n\t// select相关函数\n\t//=================\n\tinitSelect(){\n\t\tthis.select=this.model.getSelect();\n\t\tthis.selectMenu=QueryPart.getSelectMenu();\n\t}\n\t// 更改删除Select Part\n\thandleSelectPartEvent(selectParts, part, evt) {\n\t\tswitch(evt.name) {\n\t\t\t// 点击字段\n\t\t\tcase \"get-param-options\":{\n\t\t\t\treturn this.queryBuilder.queryColumns()\n\t\t\t\t\t\t\t\t\t\t.then(this.transformToSegments(true))\n\t\t\t\t\t\t\t\t\t\t.catch(this.handleQueryError.bind(this));\n\t\t\t}\n\t\t\t// 字段值发生改变\n\t\t\tcase \"part-param-changed\":{\n\t\t\t\tthis.panelCtrl.refresh();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// 点击删除图标\n\t\t\tcase \"action\":{\n\t\t\t\tthis.removeSelectPart(selectParts, part);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// 删除图标\n\t\t\tcase \"get-part-actions\":{\n\t\t\t\treturn this.$q.when([{\n\t\t\t\t\ttext: 'Remove',\n\t\t\t\t\tvalue: 'remove-part'\n\t\t\t\t}]);\n\t\t\t}\n\t\t}\n\t}\n\t// 添加Select Part\n\taddSelectPart(selectParts, cat, subitem) {\n\t\t\n\t\t// 创建QueryPart\n\t\tvar part = QueryPart.create({type: subitem.value});\n\t    part.def.addStrategy(selectParts, part, this);\n\t    \n\t    // 持久化select信息\n\t    this.model.updateSelect(this.select);\n\t    \n\t\tthis.panelCtrl.refresh();\n\t}\n\t// 删除Select Part\n\tremoveSelectPart(selectParts, part){\n\t\t// 如果删除的是field,则整个statement都删除\n\t    if (part.def.type === 'field') {\n\t      if (this.select.length > 1) {\n\t        var modelsIndex = _.indexOf(this.select, selectParts);\n\t        this.select.splice(modelsIndex, 1);\n\t      }\n\t    } else {\n\t      var partIndex = _.indexOf(selectParts, part);\n\t      selectParts.splice(partIndex, 1);\n\t    }\n \t\t// 持久化select信息\n\t\tthis.model.updateSelect(this.select);\n\t\tthis.panelCtrl.refresh();\n\t}\n\t\n\t//=================\n\t// order相关函数\n\t//=================\n\tinitOrder(){\n\t\tthis.orderBy=this.model.getOrderBy();\n\t\tthis.orderMenu=QueryPart.getOrderMenu();\n\t}\n\thandleOrderByPartEvent(part, index, evt) {\n\t\tswitch(evt.name) {\n\t\t\t// 添加分组字段\n\t\t\tcase \"get-param-options\":{\n\t\t\t\treturn this.queryBuilder.queryColumns()\n\t\t\t\t\t\t\t\t\t\t.then(this.transformToSegments(true,true))\n\t\t\t\t\t\t\t\t\t\t.catch(this.handleQueryError.bind(this));\n\t\t\t}\n\t\t\t// 分组字段更新\n\t\t\tcase \"part-param-changed\":{\n\t\t\t\tthis.panelCtrl.refresh();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// 删除分组字段\n\t\t\tcase \"action\":{\n\t\t\t\tthis.removeOrderPart(part, index);\n\t\t\t\tthis.panelCtrl.refresh();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// 分组字段删除按钮\n\t\t\tcase \"get-part-actions\":{\n\t\t\t\treturn this.$q.when([{\n\t\t\t\t\ttext: 'Remove',\n\t\t\t\t\tvalue: 'remove-part'\n\t\t\t\t}]);\n\t\t\t}\n\t\t}\n\t}\n\t// 添加Order Part\n\taddOrderPart(cat) {\n\t\tvar partModel = QueryPart.create({type: cat.value, params: ['field']});\n\t\tthis.orderBy.push(partModel);\n\t\t\n    \tthis.model.updateOrderBy(this.orderBy);\n\t\tthis.panelCtrl.refresh();\n\t}\n\t// 删除Order Part\n\tremoveOrderPart(part, index){\n\t\tthis.orderBy.splice(index,1);\n\t\tthis.model.updateOrderBy(this.select);\n\t\tthis.panelCtrl.refresh();\n\t}\n\t\n\t//=================\n\t// group相关函数\n\t//=================\n\tinitGroup() {\n\t\tthis.groupBy=this.model.getGroupBy();\n\t\tthis.tmp={};\n\t}\n\t// 分组信息\n\tgetGroupByOptions(segment,index) {\n\t\t\n\t\tvar removeSegment = this.createSegment({\n\t\t\tfake: true,\n\t\t\tvalue: '移除',\n\t\t\ttype: 'remove'\n\t\t});\n\t\tvar tmp=this.tmp;\n\t\tvar that=this;\n  \t\treturn this.queryBuilder.queryColumns()\n\t\t\t\t\t\t\t\t.then(this.transformToSegments(true,true))\n\t\t\t\t\t\t\t\t.then(results => {\n\t\t\t\t\t\t\t\t\tif(segment.type!='plus-button' ){\n\t\t\t\t\t\t\t\t\t\tresults.splice(0,0,angular.copy(this.removeSegment));\t\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tresults=_.filter(results, function(seg) {\n\t\t\t\t\t\t\t\t\t\t  return !tmp[seg.value];\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn results;\n\t\t\t\t\t\t\t\t}).catch(this.handleQueryError.bind(this));\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t}\n\t// 更新分组\n\tgroupByChanged(segment,index) {\n\t\t// 删除 \n\t\tif(segment.value === this.removeSegment.value){\n\t\t\t// 删除已选记录\n\t\t\tthis.tmp[this.groupBy[index].custom]=false;\n\t\t\tthis.groupBy.splice(index,1);\n\t\t// 添加\n\t\t}else if(segment.type==='plus-button'){\n\t\t\tsegment.type = 'group';\n\t\t\tsegment.custom=segment.value;// 使用custom自定义属性保存segment当前的value\n\t\t\t// 添加已选记录\n\t\t\tthis.tmp[segment.value]=true;\n\t\t\t\n\t\t\tthis.groupBy.splice(index+1,0,this.uiSegmentSrv.newPlusButton());\n\t\t// 更新\n\t\t}else{\n\t\t\tthis.tmp[segment.custom]=false;\n\t\t\tthis.groupBy.splice(index,1,segment);\n\t\t\tthis.tmp[segment.value]=true;\n\t\t\tsegment.custom=segment.value;\n\t\t}\n\t\t\n\t\tthis.model.updateGroupBy(this.groupBy);\n\t\tthis.panelCtrl.refresh();\n\t}\n\n\t//=================\n\t// where相关函数\n\t//=================\n\tinitWhere() {\n\n\t\t// 移除过滤条件\n\t\tthis.removeSegment = this.createSegment({\n\t\t\tfake: true,\n\t\t\tvalue: '移除'\n\t\t});\n\t\tthis.bracketSegment = this.createSegment({value: '括弧', type: 'bracket', cssClass: 'query-segment-operator' });\n\n\t\t// 查询条件\n\t\tthis.where = this.model.getWhere();\n\t\t\n\t}\n\t// Where查询条件\n\tgetWhereOptions(segment, index) {\n\t\t// 链接条件\n\t\tif(segment.type === 'condition') {\n\t\t\treturn this.$q.when([this.createSegment('AND'), this.createSegment('OR')]);\n\t\t}\n\t\t// 括弧\n\t\tif(segment.type === 'bracket'){\n\t\t\tif(segment.value==='('){\n\t\t\t\treturn this.$q.when([this.removeSegment]);\n\t\t\t}else{\n\t\t\t\treturn this.$q.when([]);\n\t\t\t}\n\t\t}\n\t\t\n\t\t// plus-button\n\t\tif(segment.type === 'plus-button'){\n\t\t\treturn this.queryBuilder.queryColumns()\n\t\t\t\t\t\t\t\t.then(this.transformToSegments(false,true))\n\t\t\t\t\t\t\t\t.then(results => {\n\t\t\t\t\t\t\t\t\tresults.splice(0, 0, angular.copy(this.bracketSegment));\t\n\t\t\t\t\t\t\t\t\treturn results;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(this.handleQueryError.bind(this));\n\t\t}\n\t\t// operator\n\t\tif(segment.type === 'operator') {\n\t\t\treturn this.$q.when(this.uiSegmentSrv.newOperators(['=', '!=', ,'>','>=','<','<=','=~', '!~','in','not in','like','not like']));\n\t\t}\n\t\t\n\t\t// key\n\t\tif(segment.type === 'key'){\n\t\t\treturn this.queryBuilder.queryColumns()\n\t\t\t\t\t\t\t\t.then(this.transformToSegments(false,true))\n\t\t\t\t\t\t\t\t.then(results => {\n\t\t\t\t\t\t\t\t\tresults.splice(0, 0, angular.copy(this.removeSegment));\n\t\t\t\t\t\t\t\t\treturn results;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(this.handleQueryError.bind(this));\n\t\t}\n\t\t// value\n\t\tif(segment.type === 'value'){\n\t\t\tvar field=this.where[index-2].value;\n\t\t\tvar aliasName=this.getAliasName();\n\t\t\tfield=aliasName[field]||field;\n\t\t\treturn this.queryBuilder.queryColumnValue('select distinct '+field+' from '+this.target.table)\n\t\t\t\t\t\t\t\t.then(results => {\n\t\t\t\t\t\t\t\t\treturn _.map(results,function(result){\n\t\t\t\t\t\t\t\t\t\treturn {text:result.text};\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(this.transformToSegments(true))\n\t\t\t\t\t\t\t\t.then(results => {\n\t\t\t\t\t\t\t\t\tif(segment.type === 'key') {\n\t\t\t\t\t\t\t\t\t\tresults.splice(0, 0, angular.copy(this.removeSegment));\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn results;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(this.handleQueryError.bind(this));\n\t\t}\n\n\t}\n\t// 更新查询条件\n\twhereChanged(segment, index) {\n\t\t\n\t\t// 删除\n\t\tif(segment.value === this.removeSegment.value){\n\t\t\t\n\t\t\t// 删除括弧\n\t\t\tif(segment.type===this.bracketSegment.type){\n\t\t\t\tvar deep=1;\n\t\t\t\tvar i=index+1;\n\t\t\t\twhile(deep!=0){\n\t\t\t\t\tif(this.where[i].value==='('){\n\t\t\t\t\t\tdeep++;\n\t\t\t\t\t}else if(this.where[i].value===')'){\n\t\t\t\t\t\tdeep--;\n\t\t\t\t\t\tif(deep==0) break;\n\t\t\t\t\t}\n\t\t\t\t\ti++;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 删除\t\t\t\n\t\t\t\tvar pre=this.where[index-1];\n\t\t\t\tif( index>1 && pre.type === 'condition' ){\n\t\t\t\t\tthis.where.splice(index-1,i-index+2);\n\t\t\t\t}else{\n\t\t\t\t\tthis.where.splice(index,i-index+1);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t}\n\t\t\t// 删除key=value\n\t\t\tif(segment.type==='key'){\n\t\t\t\t// 移除操作数、操作符和对应的值\n\t\t\t\tthis.where.splice(index, 3);\n\t\t\t\tif(this.where.length === 0) {\n\t\t\t\t\tthis.where.push(this.uiSegmentSrv.newPlusButton());\n\t\t\t\t} else if(this.where.length > 2) {\n\t\t\t\t\t// 移除逻辑符and或者or\n\t\t\t\t\tif(this.where[Math.max(index - 1, 0)].type==='condition'){\n\t\t\t\t\t\tthis.where.splice(Math.max(index - 1, 0), 1);\r\n\t\t\t\t\t}\n\t\t\t\t\tif(this.where[this.where.length - 1].type !== 'plus-button') {\n\t\t\t\t\t\tthis.where.push(this.uiSegmentSrv.newPlusButton());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\t// 添加括弧\n\t\t}else if(segment.value === this.bracketSegment.value){\n\t\t\n\t\t\t// (+)+,(+)+ and (+)+\n\t\t\tvar and=this.uiSegmentSrv.newCondition('AND');\n\t\t\tvar left=this.createSegment({value: '(', type: 'bracket', cssClass: 'query-segment-operator' });\n\t\t\tvar plus=this.uiSegmentSrv.newPlusButton();\n\t\t\tvar right=this.createSegment({value: ')', type: 'bracket', cssClass: 'query-segment-operator' });\n\t\t\tvar plus_out=this.uiSegmentSrv.newPlusButton();\n\t\t\t\n\t\t\t// 插入\t\t\t\n\t\t\tvar pre=this.where[index-1];\n\t\t\tif( index>1 && pre.value !== '(' ){\n\t\t\t\tthis.where.splice(index,1,and,left,plus,right,plus_out);// and (+)+\n\t\t\t}else{\n\t\t\t\tthis.where.splice(index,1,left,plus,right,plus_out);    // (+)+\n\t\t\t}\n\t\t\t\n\t\t// 添加key operator value\n\t\t}else if(segment.type === 'plus-button'){\n\t\t\t\n\t\t\tvar and=this.uiSegmentSrv.newCondition('AND');\n\t\t\tvar _key=segment;\n\t\t\tvar opt=this.uiSegmentSrv.newOperator('=');\n\t\t\tvar value=this.uiSegmentSrv.newFake('value', 'value', 'query-segment-value');\n\t\t\tvar plus=this.uiSegmentSrv.newPlusButton();\n\t\t\t\n\t\t\tvar segment_pre=this.where[index-1];\n\t\t\tif(index > 2 && segment_pre.value !== '(' && segment_pre.type !== 'condition') {\n\t\t\t\tthis.where.splice(index,1,and,_key,opt,value,plus);\n\t\t\t}else{\n\t\t\t\tthis.where.splice(index,1,_key,opt,value,plus);\n\t\t\t}\n\t\t\t\n\t\t\t// 修改添加操作为key\n\t\t\tsegment.type = 'key';\n\t\t\tsegment.cssClass = 'query-segment-key';\n\t\t\t\n\t\t\t// 设置字段类型\n\t\t\tthis.queryBuilder.queryColumns().then(results => {\n\t\t\t\tvar aliasName=this.getAliasName();\n\t\t\t\tvar field=aliasName[segment.value]||segment.value;\n\t\t\t\t_.map(results,function(col){\n\t\t\t\t\tif(col.text===field){\n\t\t\t\t\t\tsegment.custom=col.type;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t// 修改key\n\t\t}else if(segment.type ==='key' ){\n\t\t\tthis.where.splice(index,3);\n\t\t\tvar _key=segment;\n\t\t\tvar opt=this.uiSegmentSrv.newOperator('=');\n\t\t\tvar value=this.uiSegmentSrv.newFake('value', 'value', 'query-segment-value');\n\t\t\tthis.where.splice(index,0,_key,opt,value);\n\t\t\t\n\t\t}else{\n\t\t\t// 变更value或操作\n\t\t\tthis.where.splice(index,1,segment);\n\t\t}\n\t\t\n\t\tthis.model.updateWhere(this.where);\n\t\tthis.panelCtrl.refresh();\n\t}\n\t\n\t\n\t//=================\n\t// 公共函数\n\t//=================\n\t\n\t// 切换编辑模式\n\ttoggleEditorMode() {\n      \tthis.target.query = this.model.render(false);\n      \tthis.sql=this.target.query;\n\t\tthis.target.rawQuery = !this.target.rawQuery;\n\t}\n\t// 编辑器\n\tinitEditor(){\n\t\tthis.sql=this.target.query;\n\t\tthis.editor=this.editor||new SQLEditor();\n\t}\n\t// 格式化SQL\n\tformat(){\n\t\tthis.sql=this.editor.format(this.sql);\n\t}\n\t// 保存SQL\n\tsave(){\n\t\tthis.target.query=this.sql;\n\t\tthis.alertSrv.set('消息','SQL保存成功','success',3000);\n\t}\n\t// 执行SQL\n\texecute(){\n\t\tthis.panelCtrl.refresh();\n\t}\n\tgetCollapsedText() {\n\t\treturn this.model.render(false);\n\t}\n\t\n\t// 转换成Segments格式\n\ttransformToSegments(addTemplateVars,addAliasName) {\n\t\t\tvar aliasName=this.getAliasName();\n\t\t\treturn(results) => {\n\t\t\t\tvar segments = _.map(results, segment => {\n\t\t\t\t\treturn this.createSegment({\n\t\t\t\t\t\tvalue: segment.text,\n\t\t\t\t\t\texpandable: segment.expandable\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\t// 模板变量\n\t\t\t\tif(addTemplateVars) {\n\t\t\t\t\tfor(let variable of this.templateSrv.variables) {\n\t\t\t\t\t\tsegments.unshift(this.createSegment({\n\t\t\t\t\t\t\ttype: 'template',\n\t\t\t\t\t\t\tvalue: '$' + variable.name,\n\t\t\t\t\t\t\texpandable: true\n\t\t\t\t\t\t}));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// 别名\n\t\t\t\tif(addAliasName){\n\t\t\t\t\tvar self=this;\n\t\t\t\t\t_.map(aliasName,function(field,as){\n\t\t\t\t\t\tsegments.unshift(self.createSegment({\n\t\t\t\t\t\t\ttype: 'template',\n\t\t\t\t\t\t\tvalue: as,\n\t\t\t\t\t\t\texpandable: true\n\t\t\t\t\t\t}));\n\t\t\t\t\t})\n\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\treturn segments;\n\t\t\t};\n\t\t}\n\t// 错误处理\n\thandleQueryError(err) {\n\t\tthis.error = err.message || 'Failed to issue metric query';\n\t\treturn [];\n\t}\n\t// 创建UI显示块\n\tcreateSegment(options){\n\t\treturn this.uiSegmentSrv.newSegment(options);\n\t}\n\t// 遍历select获取别名\n\tgetAliasName(){\n\t\tvar selectmenu=QueryPart.getCategory();\n\t\tvar aliasName={}\n\t\t_.map(this.select, function(selectParts) {\n\t\t\tvar field=undefined;\n\t\t\tvar as=undefined;\n\t\t\t _.map(selectParts, function(part) {\n\t\t\t \tif(part.def.category===selectmenu.Fields.category){\n\t\t\t \t\tfield=part.params[0];\n\t\t\t \t}\n\t\t\t\tif(part.def.category===selectmenu.AS.category){\n\t\t\t\t\tas=part.params[0];\n\t\t\t\t}\n\t\t\t});\n\t\t\tif(as){\n\t\t\t\taliasName[as]=field;\n\t\t\t}\n\t\t});\n\t\treturn aliasName;\n\t}\n}\n\n// 模板对象\nSQLQueryCtrl.templateUrl = 'partials/query.editor.html';"]}