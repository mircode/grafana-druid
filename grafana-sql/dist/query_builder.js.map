{"version":3,"sources":["../src/query_builder.js"],"names":["_","QueryBuilder","target","database","rawQuery","_modifyRawQuery","_buildQuery","tag","index","str","operator","value","condition","test","isNaN","key","type","withKey","withMeasurementFilter","query","measurement","match","tags","length","whereConditions","reduce","memo","push","renderTagCondition","join"],"mappings":";;;;;;;;;;;;;;;AACOA,O;;;;;;;;;;;;;;;;;;;;;8BAGMC,Y;;AAEZ;AACA,8BAAYC,MAAZ,EAAmBC,QAAnB,EAA4B;AAAA;;AAC3B,eAAKD,MAAL,GAAcA,MAAd;AACE,eAAKC,QAAL,GAAgBA,QAAhB;AACF;;;;kCACM;AACJ,mBAAO,KAAKD,MAAL,CAAYE,QAAZ,GAAuB,KAAKC,eAAL,EAAvB,GAAgD,KAAKC,WAAL,EAAvD;AACD;;;6CAGmBC,G,EAAKC,K,EAAO;AAC9B,gBAAIC,MAAM,EAAV;AACA,gBAAIC,WAAWH,IAAIG,QAAnB;AACA,gBAAIC,QAAQJ,IAAII,KAAhB;AACA,gBAAIH,QAAQ,CAAZ,EAAe;AACbC,oBAAM,CAACF,IAAIK,SAAJ,IAAiB,KAAlB,IAA2B,GAAjC;AACD;;AAED,gBAAI,CAACF,QAAL,EAAe;AACb,kBAAI,WAAWG,IAAX,CAAgBN,IAAII,KAApB,CAAJ,EAAgC;AAC9BD,2BAAW,IAAX;AACD,eAFD,MAEO;AACLA,2BAAW,GAAX;AACD;AACF;;AAED;AACA,gBAAIA,aAAa,IAAb,IAAqBA,aAAa,IAAlC,IAA0CI,MAAM,CAACH,KAAP,CAA9C,EAA6D;AAC3DA,sBAAQ,MAAMA,KAAN,GAAc,GAAtB;AACD;;AAED,mBAAOF,MAAM,GAAN,GAAYF,IAAIQ,GAAhB,GAAsB,IAAtB,GAA6BL,QAA7B,GAAwC,GAAxC,GAA8CC,KAArD;AACD;;;wCAGY,CAEZ;;;yCAEa,CAEb;;;qCAES,CAET;;;4CAKiBK,I,EAAMC,O,EAASC,qB,EAAuB;AACtD,gBAAIC,KAAJ;AACA,gBAAIC,WAAJ;;AAEA,gBAAIJ,SAAS,UAAb,EAAyB;AACvBG,sBAAQ,eAAR;AACAC,4BAAc,KAAKlB,MAAL,CAAYkB,WAA1B;AACD,aAHD,MAGO,IAAIJ,SAAS,YAAb,EAA2B;AAChCG,sBAAQ,iBAAR;AACAC,4BAAc,KAAKlB,MAAL,CAAYkB,WAA1B;AACD,aAHM,MAGA,IAAIJ,SAAS,cAAb,EAA6B;AAClCG,sBAAQ,mBAAR;AACA,kBAAID,qBAAJ,EACA;AACEC,yBAAS,2BAA2BD,qBAA3B,GAAkD,GAA3D;AACD;AACF,aANM,MAMA,IAAIF,SAAS,QAAb,EAAuB;AAC5BG,sBAAQ,2BAA2B,KAAKjB,MAAL,CAAYkB,WAAvC,GAAqD,GAA7D;AACA,qBAAOD,KAAP;AACD,aAHM,MAGA,IAAIH,SAAS,oBAAb,EAAmC;AACxCG,sBAAQ,iCAAiC,KAAKhB,QAAtC,GAAiD,GAAzD;AACA,qBAAOgB,KAAP;AACD;;AAED,gBAAIC,WAAJ,EAAiB;AACf,kBAAI,CAACA,YAAYC,KAAZ,CAAkB,OAAlB,CAAD,IAA+B,CAACD,YAAYC,KAAZ,CAAkB,cAAlB,CAApC,EAAuE;AACrED,8BAAc,MAAMA,WAAN,GAAmB,GAAjC;AACD;AACDD,uBAAS,WAAWC,WAApB;AACD;;AAED,gBAAIH,OAAJ,EAAa;AACXE,uBAAS,kBAAkBF,OAAlB,GAA4B,GAArC;AACD;;AAED,gBAAI,KAAKf,MAAL,CAAYoB,IAAZ,IAAoB,KAAKpB,MAAL,CAAYoB,IAAZ,CAAiBC,MAAjB,GAA0B,CAAlD,EAAqD;AACnD,kBAAIC,kBAAkBxB,EAAEyB,MAAF,CAAS,KAAKvB,MAAL,CAAYoB,IAArB,EAA2B,UAASI,IAAT,EAAenB,GAAf,EAAoB;AACnE;AACA,oBAAIA,IAAIQ,GAAJ,KAAYE,OAAhB,EAAyB;AACvB,yBAAOS,IAAP;AACD;AACDA,qBAAKC,IAAL,CAAUC,mBAAmBrB,GAAnB,EAAwBmB,KAAKH,MAA7B,CAAV;AACA,uBAAOG,IAAP;AACD,eAPqB,EAOnB,EAPmB,CAAtB;;AASA,kBAAIF,gBAAgBD,MAAhB,GAAyB,CAA7B,EAAgC;AAC9BJ,yBAAU,YAAYK,gBAAgBK,IAAhB,CAAqB,GAArB,CAAtB;AACD;AACF;;AAED,mBAAOV,KAAP;AACD","file":"query_builder.js","sourcesContent":["\nimport _ from 'lodash';\n\n// 用于发起后台请求\nexport class QueryBuilder{\n\t\n\t// 构造函数\n\tconstructor(target,database){\n\t\tthis.target = target;\n    this.database = database;\n\t}\n\tbuild(){\n    return this.target.rawQuery ? this._modifyRawQuery() : this._buildQuery();\n  };\n  \n\t // 渲染查询条件\n  renderTagCondition (tag, index) {\n    var str = \"\";\n    var operator = tag.operator;\n    var value = tag.value;\n    if (index > 0) {\n      str = (tag.condition || 'AND') + ' ';\n    }\n\n    if (!operator) {\n      if (/^\\/.*\\/$/.test(tag.value)) {\n        operator = '=~';\n      } else {\n        operator = '=';\n      }\n    }\n\n    // quote value unless regex or number\n    if (operator !== '=~' && operator !== '!~' && isNaN(+value)) {\n      value = \"'\" + value + \"'\";\n    }\n\n    return str + '\"' + tag.key + '\" ' + operator + ' ' + value;\n  }\n\n\t// 查询表格信息\n  queryTables(){\n  \t\n  }\n  // 查询取列信息\n  queryColumns(){\n  \t\n  }\n  // 查询SQL\n  querySql(){\n  \t\n  }\n  \n\n  \n\n  buildExploreQuery(type, withKey, withMeasurementFilter) {\n    var query;\n    var measurement;\n\n    if (type === 'TAG_KEYS') {\n      query = 'SHOW TAG KEYS';\n      measurement = this.target.measurement;\n    } else if (type === 'TAG_VALUES') {\n      query = 'SHOW TAG VALUES';\n      measurement = this.target.measurement;\n    } else if (type === 'MEASUREMENTS') {\n      query = 'SHOW MEASUREMENTS';\n      if (withMeasurementFilter)\n      {\n        query += ' WITH MEASUREMENT =~ /' + withMeasurementFilter +'/';\n      }\n    } else if (type === 'FIELDS') {\n      query = 'SHOW FIELD KEYS FROM \"' + this.target.measurement + '\"';\n      return query;\n    } else if (type === 'RETENTION POLICIES') {\n      query = 'SHOW RETENTION POLICIES on \"' + this.database + '\"';\n      return query;\n    }\n\n    if (measurement) {\n      if (!measurement.match('^/.*/') && !measurement.match(/^merge\\(.*\\)/)) {\n        measurement = '\"' + measurement+ '\"';\n      }\n      query += ' FROM ' + measurement;\n    }\n\n    if (withKey) {\n      query += ' WITH KEY = \"' + withKey + '\"';\n    }\n\n    if (this.target.tags && this.target.tags.length > 0) {\n      var whereConditions = _.reduce(this.target.tags, function(memo, tag) {\n        // do not add a condition for the key we want to explore for\n        if (tag.key === withKey) {\n          return memo;\n        }\n        memo.push(renderTagCondition(tag, memo.length));\n        return memo;\n      }, []);\n\n      if (whereConditions.length > 0) {\n        query +=  ' WHERE ' + whereConditions.join(' ');\n      }\n    }\n\n    return query;\n  };\n}\n\t\n"]}